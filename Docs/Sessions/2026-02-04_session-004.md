# Session 2026-02-04 - session-004 (Authentication + Role Routing)

## Goals
- Implement Firebase Auth email/password login
- Determine role via users/{uid} and route accordingly

## Context
- PRD: no signup; after login read users/{uid}.role to route to student/teacher experience

## Atomic Tasks
1) Implement Connexion screen -- DONE:
   - Logo top center
   - French labels (Adresse e-mail, Mot de passe, Se connecter)
   - Form validation (empty fields, invalid email)
   - Loading state (spinner on button)
   - Error mapping: invalid-email, user-not-found, wrong-password, user-disabled, too-many-requests, invalid-credential
   - Password visibility toggle
2) Implement auth session handling -- DONE:
   - authStateProvider (StreamProvider watching FirebaseAuth.authStateChanges)
   - Logout via AuthService.signOut() wired to drawer button
3) Implement post-login bootstrap -- DONE:
   - appUserProvider fetches users/{uid} from Firestore
   - AppUser model with role, fullName, personalNumber, classId, teacherClassIds
   - isStudent / isTeacher getters
4) Add guarded routing -- DONE:
   - Unauthenticated -> /login (Connexion)
   - Authenticated on /login -> / (home)
   - _RouterRefreshNotifier triggers GoRouter redirect on auth state change

## Tests
- flutter analyze: 0 issues
- flutter test: 1 test passed

## Errors
- None

## Outputs
Files created:
- lib/domain/models/app_user.dart (AppUser model with fromFirestore/toFirestore)
- lib/data/firebase/auth_service.dart (AuthService: signIn, signOut, fetchUserProfile, sendPasswordReset)
- lib/features/auth/auth_providers.dart (authServiceProvider, authStateProvider, appUserProvider)
- lib/features/auth/login_page.dart (Connexion screen with form, validation, French errors)

Files modified:
- lib/app/router.dart (added /login route, auth redirect, _RouterRefreshNotifier)
- lib/shared/widgets/app_scaffold.dart (converted to ConsumerWidget, wired logout)

## Next Steps
- Session-005: Firestore schema + security rules baseline
