# Session 2026-02-04 - session-005 (Firestore Schema + Security Rules Baseline)

## Goals
- Establish Firestore schema per PRD
- Implement least-privilege security rules

## Context
- PRD requires strict access:
  - students only their class
  - teachers only their classes/subjects
  - attendance and assessments writes through Cloud Functions only

## Atomic Tasks
1) Define Firestore collections and doc shapes -- DONE (documented in API_Routes.md)
2) Implement Firestore rules -- DONE (firestore.rules):
   - users: read own doc, update editable fields only (immutable fields enforced)
   - classes subtree: read for class members only
   - assessments/attendanceSessions/records: read for class members, write denied (Cloud Functions only)
   - classChat: read/create for class members, serverTimestamp enforced
   - subjectChats: read/create for students + subject teacher only
3) Set up Firebase project config -- DONE:
   - firebase.json with emulator ports
   - .firebaserc with dev/prod project aliases
   - Emulator config: auth:9099, firestore:8080, functions:5001, storage:9199, ui:4000
   - Note: Firebase CLI required to run emulators (install separately)
4) Document rules invariants in Docs/API_Routes.md -- DONE

## Additional outputs
- firestore.indexes.json: composite indexes for assessments, messages, timetableSlots
- storage.rules: profile photo access (own photo write, any auth read, 5MB limit)

## Tests
- flutter analyze: 0 issues
- flutter test: 1 test passed
- Firebase emulator rules testing: deferred (requires Firebase CLI installation)

## Errors
- None

## Outputs
Files created:
- firebase.json (Firebase project config with emulator ports)
- .firebaserc (project aliases: study-planner-dev, study-planner-prod)
- firestore.rules (complete security rules per PRD)
- firestore.indexes.json (composite indexes for assessments, messages, timetable)
- storage.rules (profile photo access rules)

Files modified:
- Docs/API_Routes.md (detailed rules documentation with per-collection table)

## Next Steps
- Session-006: Cloud Functions - attendance open + submit
