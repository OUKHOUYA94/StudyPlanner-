# Session 2026-02-04 - session-006 (Cloud Functions: Attendance)

## Goals
- Implement createAttendanceSession and submitAttendance
- Ensure 3-minute expiration and checkedAt serverTimestamp

## Context
- PRD: teacher selects session, opens QR valid 3 minutes; students scan; backend verifies and stores checkedAt

## Atomic Tasks
1) Set up Cloud Functions project (TypeScript) -- DONE:
   - functions/package.json with firebase-admin + firebase-functions
   - functions/tsconfig.json (strict, ES2020, commonjs)
   - npm install completed
2) Implement createAttendanceSession -- DONE:
   - Auth: verifies caller is teacher
   - Validates teacher has access to classId (teacherClassIds)
   - Verifies timetableSlotId exists and belongs to class
   - Verifies slot is scheduled for today (dayOfWeek check)
   - Generates 32-byte random token, stores SHA-256 hash
   - Creates session doc with expiresAt = now + 3 minutes
   - Returns: sessionId, token (plaintext), expiresAt (ISO string)
   - All error messages in French
3) Implement submitAttendance -- DONE:
   - Auth: verifies caller is student
   - Validates student belongs to classId
   - Verifies session exists and status is "open"
   - Verifies session has not expired (timestamp comparison)
   - Verifies token hash matches (SHA-256)
   - Prevents duplicate scans (checks records/{uid} exists)
   - Writes record with checkedAt = serverTimestamp
   - Returns: success + checkedAt
   - All error messages in French
4) Rules already deny client writes (session-005) -- confirmed

## Tests
- TypeScript build (tsc): 0 errors
- flutter analyze: 0 issues
- flutter test: 1 test passed
- Firebase emulator function tests: deferred (requires Firebase CLI)

## Errors
- None

## Outputs
Files created:
- functions/package.json (project config + dependencies)
- functions/tsconfig.json (TypeScript config)
- functions/.gitignore (lib/ + node_modules/)
- functions/src/index.ts (entry point, exports attendance functions)
- functions/src/attendance.ts (createAttendanceSession + submitAttendance)

## Next Steps
- Session-007: Teacher Presences UI (select session -> open QR -> countdown)
