# Session 2026-02-04 - session-010 (Assessments CRUD + Weekly Limit)

## Goals
- Implement teacher assessment create/update/cancel UI
- Enforce max 3 assessments per ISO week per class (Cloud Functions)

## Context
- PRD: assessment CRUD only for teacher; server enforced max 3/week/class

## Atomic Tasks
1) Implement Cloud Functions: createAssessment, updateAssessment, cancelAssessment -- DONE:
   - createAssessment: teacher auth + class access + ISO week max 3 check + create doc
   - updateAssessment: teacher auth + update allowed fields + re-check weekly limit if dateTime changes
   - cancelAssessment: teacher auth + set status to "canceled" + optional reason
   - ISO week bounds helper: isoWeekBounds() computes Monday-to-Monday range
   - verifyTeacherAccess() helper: shared auth + class permission check
2) Add callable function wrappers to Flutter providers -- DONE:
   - callCreateAssessment(), callUpdateAssessment(), callCancelAssessment()
3) Implement create assessment form (teacher only) -- DONE:
   - AssessmentFormPage: class selector, subject selector (from timetable), title, type dropdown, date/time pickers
   - Create mode (no assessment param) and Edit mode (assessment param)
   - Subject list fetched from timetable slots of selected class
   - Form validation with French messages
   - Success/error snackbars
4) Add teacher actions to assessments page -- DONE:
   - FAB (create) visible only for teacher role
   - Edit/Cancel buttons on each assessment card (teacher only, non-canceled)
   - Cancel confirmation dialog ("Etes-vous sur de vouloir annuler cet examen ?")
   - Provider invalidation after mutations (todayAssessmentsProvider + weekAssessmentsProvider)
5) Lock down direct client writes to assessments -- already enforced by Firestore rules (session-005)

## Tests
- tsc build: 0 errors
- flutter analyze: 0 issues
- flutter test: 1 test passed

## Errors
- TypeScript: used Dart-style named params (isGreaterThanOrEqualTo:) in Admin SDK where() -> fixed to positional (">=")
- Flutter: DropdownButtonFormField `value` deprecated -> fixed to `initialValue` with ValueKey for rebuild

## Outputs
Files created:
- functions/src/assessments.ts (createAssessment, updateAssessment, cancelAssessment, isoWeekBounds, verifyTeacherAccess)
- lib/features/assessments/assessment_form_page.dart (AssessmentFormPage with create/edit modes)

Files modified:
- functions/src/index.ts (export new assessment functions)
- lib/features/assessments/assessments_providers.dart (added cloud_functions import + 3 callable wrappers)
- lib/features/assessments/assessments_page.dart (added FAB, teacher edit/cancel actions, role-aware cards)

## Next Steps
- Session-011: Subjects (6 per class) UI + subject chat entry
