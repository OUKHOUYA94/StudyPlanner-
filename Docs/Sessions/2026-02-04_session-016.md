# Session 2026-02-04 - session-016 (FCM, QA, Deployment)

## Goals
- Optional but recommended: enable FCM notifications
- Run QA against PRD acceptance checklist
- Prepare deployment and Android release build

## Context
- PRD: functions + rules deployed; release build for Android

## Atomic Tasks
1) Configure FCM (Android) -- DONE:
   - Added firebase_messaging: ^15.2.0 to pubspec.yaml
   - Created NotificationService with permission request, token registration
   - FCM initialization triggered when user logs in

2) Store device tokens under users/{uid}/devices -- DONE:
   - NotificationService saves token to Firestore
   - Token refresh listener updates Firestore
   - Token removed on logout
   - Firestore rules updated to allow devices subcollection

3) Implement notification triggers -- DONE:
   - onAssessmentCreated: notifies class members of new assessment
   - onAssessmentUpdated: notifies class members of canceled/rescheduled assessment
   - Invalid tokens cleaned up automatically

4) Run acceptance checklist from PRD -- DONE:
   - Created Docs/QA_Checklist.md with comprehensive feature tests
   - Covers all sessions: auth, navigation, attendance, assessments, messaging, settings
   - Security rules verification included
   - Performance and localization checks

5) Deploy guide created -- DONE:
   - Created Docs/Deployment_Guide.md
   - Firebase project setup instructions
   - Security rules deployment
   - Cloud Functions deployment
   - Seed script usage
   - Android release build instructions
   - Troubleshooting section

6) Build verification -- DONE:
   - tsc build: 0 errors
   - flutter analyze: 0 issues
   - flutter test: 1 test passed

## Tests
- flutter analyze: 0 issues
- flutter test: 1 test passed
- tsc build: 0 errors

## Errors
- None

## Outputs
Files created:
- lib/data/firebase/notification_service.dart (FCM setup, token registration)
- lib/features/notifications/notification_providers.dart (notificationServiceProvider, notificationInitProvider)
- functions/src/notifications.ts (onAssessmentCreated, onAssessmentUpdated)
- Docs/QA_Checklist.md (comprehensive test checklist)
- Docs/Deployment_Guide.md (deployment instructions)

Files modified:
- pubspec.yaml (added firebase_messaging: ^15.2.0)
- functions/src/index.ts (exported notification functions)
- firestore.rules (added users/{uid}/devices/{deviceId} rules)
- lib/shared/widgets/app_scaffold.dart (FCM init, token removal on logout)
- lib/features/settings/settings_page.dart (token removal on logout)

## Project Status

### Completed Sessions (16/16)
| Session | Feature |
|---------|---------|
| 001 | Firebase docs and workflow |
| 002 | Session planning |
| 003 | Flutter bootstrap + navigation |
| 004 | Auth login + role routing |
| 005 | Firestore rules + indexes |
| 006 | Cloud Functions: attendance |
| 007 | Teacher Présences UI |
| 008 | Student QR Scanner |
| 009 | Accueil + Examens view |
| 010 | Assessments CRUD |
| 011 | Subjects/Matières UI |
| 012 | Messaging (class + subject chats) |
| 013 | Teacher attendance list |
| 014 | Settings (photo, email, logout) |
| 015 | Seed script |
| 016 | FCM notifications + QA + deployment |

### Deliverables
- Flutter Android app (release-ready)
- Firebase backend (Firestore, Auth, Storage, Functions)
- Seed script for demo data
- QA checklist
- Deployment guide
- Complete documentation

## Next Steps
- **PROJECT COMPLETE**
- Deploy to Firebase
- Run seed script
- Build release APK
- Distribute for testing
